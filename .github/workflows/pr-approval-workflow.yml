name: PR Approval & Trigger

env:
  ALLOWED_APPROVERS: '["bkris2","Ishup146","git-cc-aman"]'
  APPROVAL_MESSAGE: 'bkris2, Ishup146, git-cc-aman'

on:
  push:
    branches: [master,main,develop]
  pull_request:
    branches: [master,main,develop]
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  check-approval:
    if: (github.event_name == 'push' && contains(fromJson('["master","main","develop"]'), github.ref_name)) || (github.event_name != 'push' && contains(fromJson('["master","main","develop"]'), github.event.pull_request.base.ref))
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.check_approval.outputs.approved }}
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if approved by required approvers
        id: check_approval
        uses: actions/github-script@v6
        env:
          ALLOWED_APPROVERS: ${{ env.ALLOWED_APPROVERS }}
        with:
          script: |
            const allowedApprovers = JSON.parse(process.env.ALLOWED_APPROVERS);

            let approved = false;

            if (context.eventName === 'push') {
              const { owner, repo } = context.repo;
              const commitSha = context.sha;

              const prsForCommit = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: commitSha,
              });

              const mergedPr = prsForCommit.data.find(
                pr => pr.merged_at && ['master', 'main', 'develop'].includes(pr.base.ref)
              );

              if (mergedPr) {
                const reviews = await github.rest.pulls.listReviews({
                  owner,
                  repo,
                  pull_number: mergedPr.number,
                });

                approved = reviews.data.some(review =>
                  allowedApprovers.includes(review.user.login) && review.state === 'APPROVED'
                );
              }
            } else {
              const { owner, repo, number } = context.issue;
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: number
              });

              approved = reviews.data.some(review =>
                allowedApprovers.includes(review.user.login) && review.state === 'APPROVED'
              );
            }

            console.log(`Approval by required approvers: ${approved}`);
            core.setOutput('approved', approved);

      - name: Fail if PR approval is missing
        if: steps.check_approval.outputs.approved != 'true'
        run: |
          echo "⏳ PR is waiting for approval from one of: ${{ env.APPROVAL_MESSAGE }}"
          echo "❌ Approval gate failed. Build will not run without required PR approval."
          exit 1

  build-and-test:
    needs: check-approval
    if: needs.check-approval.outputs.approved == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || echo "No requirements.txt found"

      - name: Run linting
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Run tests
        run: |
          pip install pytest
          pytest tests/ -v 2>/dev/null || echo "No tests found"

      - name: ✅ Workflow completed successfully
        run: echo "All checks passed after required approval!"
