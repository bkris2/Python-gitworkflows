name: PR Approval & Trigger

on:
  pull_request:
    branches: [master,main,develop]
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  check-approval:
    if: contains(fromJson('["master","main","develop"]'), github.event.pull_request.base.ref)
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.check_approval.outputs.approved }}
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if approved by required approvers
        id: check_approval
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: number
            });

            const allowedApprovers = ['bkris2', 'Ishup146', 'git-cc-aman'];

            const approved = reviews.data.some(review =>
              allowedApprovers.includes(review.user.login) && review.state === 'APPROVED'
            );

            console.log(`Approval by required approvers: ${approved}`);
            core.setOutput('approved', approved);

      - name: Waiting for PR approval
        if: steps.check_approval.outputs.approved != 'true'
        run: |
          echo "⏳ PR is waiting for approval from one of: bkris2, Ishup146, git-cc-aman"

  build-and-test:
    needs: check-approval
    if: contains(fromJson('["master","main","develop"]'), github.event.pull_request.base.ref) && needs.check-approval.outputs.approved == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || echo "No requirements.txt found"

      - name: Run linting
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Run tests
        run: |
          pip install pytest
          pytest tests/ -v 2>/dev/null || echo "No tests found"

      - name: ✅ Workflow completed successfully
        run: echo "All checks passed after required approval!"
