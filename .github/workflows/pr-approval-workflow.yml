name: PR Approval & Trigger

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  pull_request_review:
    branches: [main, develop]
    types: [submitted]

jobs:
  check-approval:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if approved by bkris2
        id: check_approval
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: number
            });

            const approvalByBkris2 = reviews.data.some(review =>
              review.user.login === 'bkris2' && review.state === 'APPROVED'
            );

            console.log(`Approval by bkris2: ${approvalByBkris2}`);
            core.setOutput('approved', approvalByBkris2);

      - name: Fail if not approved by bkris2
        if: steps.check_approval.outputs.approved != 'true'
        run: |
          echo "❌ PR must be approved by bkris2 before workflow can proceed"
          exit 1

  build-and-test:
    needs: check-approval
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || echo "No requirements.txt found"

      - name: Run linting
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Run tests
        run: |
          pip install pytest
          pytest tests/ -v 2>/dev/null || echo "No tests found"

      - name: ✅ Workflow completed successfully
        run: echo "All checks passed after bkris2 approval!"
